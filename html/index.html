	<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Surveyor AI</title>

  <style>
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,.05);
      --panel2: rgba(255,255,255,.07);
      --border: rgba(255,255,255,.12);
      --text: #e5e7eb;
      --muted:#9aa7bd;
      --accent:#3b82f6;
      --accent2:#22c55e;
      --danger:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 15% 0%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(147,51,234,.12), transparent 60%),
        var(--bg);
      padding: 18px;
    }

    .app{
      max-width: 1280px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
      height: calc(100vh - 36px);
      min-height: 560px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    /* Sidebar */
    .side{
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .sideTop{
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 40%),
        linear-gradient(135deg, rgba(59,130,246,1), rgba(34,197,94,1));
      box-shadow: 0 12px 24px rgba(59,130,246,.18);
      flex: 0 0 auto;
    }
    .title{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .title b{
      font-size: 1.05rem;
      line-height: 1.1;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .title span{
      font-size: .82rem;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .iconBtn{
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
    }

    .sideBody{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      overflow:auto;
      min-height: 0;
    }

    .field label{
      display:block;
      font-size:.8rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    select, input[type="range"], input[type="number"], textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.55);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
    }
    select{ cursor:pointer; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .pillRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .pill{
      font-family: var(--mono);
      font-size:.72rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: rgba(229,231,235,.85);
    }

    .btnRow{
      display:flex;
      gap: 10px;
    }
    button{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      padding: 10px 12px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(59,130,246,.25);
      border-color: rgba(59,130,246,.35);
    }
    button.primary:hover{ background: rgba(59,130,246,.32); }
    button.danger{
      background: rgba(239,68,68,.16);
      border-color: rgba(239,68,68,.28);
    }

    .sectionTitle{
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      font-size:.85rem;
      color: rgba(229,231,235,.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .smallMuted{ font-size:.8rem; color: var(--muted); }

    .sessions{
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding-bottom: 6px;
    }
    .sess{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sess:hover{ background: rgba(255,255,255,.07); }
    .sess .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .sess .name{
      font-weight: 600;
      font-size:.92rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .sess .meta{
      font-size:.78rem;
      color: var(--muted);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tagMini{
      font-family: var(--mono);
      font-size:.70rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: rgba(229,231,235,.85);
      flex: 0 0 auto;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .status{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .status .line1{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .dot{
      width:10px; height:10px; border-radius: 50%;
      background: rgba(34,197,94,.85);
      box-shadow: 0 0 0 3px rgba(34,197,94,.15);
      flex: 0 0 auto;
    }
    .status .title2{
      font-weight: 700;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .status .line2{
      font-size:.82rem;
      color: var(--muted);
    }
    .topRight{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .chat{
      flex: 1 1 auto;
      padding: 16px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap: 12px;
      scroll-behavior:smooth;
      min-height:0;
    }

    .bubble{
      max-width: 78%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .bubble .meta{
      font-size:.75rem;
      color: rgba(229,231,235,.78);
      margin-bottom: 6px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .bubble .meta .who{ font-weight: 700; }
    .bubble .meta .time{
      font-family: var(--mono);
      font-size:.70rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: rgba(229,231,235,.85);
    }

    .me{
      align-self:flex-end;
      background: rgba(59,130,246,.16);
      border-color: rgba(59,130,246,.28);
    }
    .bot{
      align-self:flex-start;
      background: rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.26);
    }
    .err{
      align-self:flex-start;
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.30);
    }

    .typingDots{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .td{
      width: 6px; height: 6px;
      border-radius: 50%;
      background: rgba(229,231,235,.75);
      animation: bounce 1s infinite ease-in-out;
    }
    .td:nth-child(2){ animation-delay: .15s; }
    .td:nth-child(3){ animation-delay: .30s; }
    @keyframes bounce{
      0%, 80%, 100%{ transform: translateY(0); opacity:.45; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    .composer{
      border-top: 1px solid var(--border);
      padding: 14px;
      background: rgba(0,0,0,.10);
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    .composer textarea{
      min-height: 48px;
      max-height: 180px;
      resize:none;
      font-size: 1rem;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(2,6,23,.60);
    }
    .hintRow{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0 14px 14px;
      font-size: .8rem;
      color: var(--muted);
    }
    .kbd{
      font-family: var(--mono);
      font-size:.72rem;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(229,231,235,.85);
    }

    /* Modal */
    .modalWrap{
      position: fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.45);
      padding: 18px;
    }
    .modal{
      width: min(760px, 96vw);
      max-height: min(82vh, 720px);
      overflow:auto;
      border-radius: 18px;
      background: rgba(10,18,32,.92);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 14px;
      backdrop-filter: blur(12px);
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 6px 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      margin-bottom: 12px;
    }
    .modalTop b{ font-size: 1rem; }
    .modalGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.12);
      margin-top: 12px;
    }

    @media (max-width: 980px){
      body{ padding: 12px; }
      .app{ grid-template-columns: 1fr; height:auto; min-height: 0; }
      .side{ height:auto; }
      .main{ height: calc(100vh - 24px); }
    }
  </style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <div class="card side">
    <div class="sideTop">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>Surveyor AI</b>
          <span id="userEmail">@burakustuner.com</span>
        </div>
      </div>
      <button class="iconBtn" id="openSettings" title="Ayarlar">‚öôÔ∏è</button>
    </div>

    <!-- Auth Section -->
    <div class="sideBody" id="authSection" style="border-bottom: 1px solid var(--border); padding: 14px; padding-bottom: 14px; margin-bottom: 10px; overflow: visible; min-height: auto;">
      <div id="loginSection">
        <button class="primary" id="googleSignIn" type="button" style="width: 100%;">üîê Google ile Giri≈ü</button>
        <div class="smallMuted" style="margin-top: 6px; text-align: center; font-size: 0.75rem;">API kullanƒ±mƒ± i√ßin giri≈ü gerekli</div>
      </div>
      <div id="userSection" style="display: none;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <img id="userPicture" src="" style="width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--border); flex-shrink: 0;" />
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3;" id="userName">Kullanƒ±cƒ±</div>
            <div class="smallMuted" id="rateLimitInfo" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.7rem; line-height: 1.3; margin-top: 3px;">Y√ºkleniyor...</div>
          </div>
        </div>
        <button class="danger" id="googleSignOut" type="button" style="width: 100%; padding: 6px 10px; font-size: 0.8rem; line-height: 1.4;">√áƒ±kƒ±≈ü Yap</button>
      </div>
    </div>

    <div class="sideBody">
      <div class="field">
        <label>Model</label>
        <select id="model">
          <option value="">Modeller y√ºkleniyor‚Ä¶</option>
        </select>
        <div class="smallMuted" id="modelHint"></div>
      </div>

      <div class="field">
        <label>Prompt ≈ûablonu</label>
        <select id="template"></select>
      </div>

      <div class="row">
        <div class="field">
          <label>Context (num_ctx)</label>
          <input id="ctx" type="number" min="256" max="32768" step="256" />
          <div class="pillRow"><span class="pill" id="ctxPill">ctx: -</span></div>
        </div>

        <div class="field">
          <label>Temperature</label>
          <input id="temp" type="range" min="0" max="1.5" step="0.05" />
          <div class="pillRow"><span class="pill" id="tempPill">temp: -</span></div>
        </div>
      </div>

      <div class="field">
        <label>Ge√ßmi≈üi sohbete ekle (son N mesaj)</label>
        <input id="historyLimit" type="number" min="0" max="50" step="1" />
        <div class="smallMuted">0 = sadece son soruyu g√∂nderir (context yok).</div>
      </div>

      <div class="field">
        <label>Streaming</label>
        <div class="pillRow">
          <button id="toggleStream" class="primary" type="button">Aktif</button>
          <span class="pill" id="streamPill">stream: on</span>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="newChat" type="button">+ Yeni sohbet</button>
        <button class="danger" id="clearChat" type="button">Temizle</button>
      </div>

      <div class="sectionTitle">
        <span>Sohbetler</span>
        <span class="smallMuted" id="sessCount">0</span>
      </div>

      <div class="sessions" id="sessions"></div>

    </div>
  </div>

  <!-- Main -->
  <div class="card main">
    <div class="topbar">
      <div class="status">
        <div class="line1">
          <span class="dot" id="statusDot"></span>
          <span class="title2" id="chatTitle">Yeni sohbet</span>
        </div>
        <div class="line2" id="chatSub">Enter g√∂nderir ‚Ä¢ Shift+Enter alt satƒ±r ‚Ä¢ Streaming aktif</div>
      </div>

      <div class="topRight">
        <span class="pill" id="topCtx">ctx: -</span>
        <span class="pill" id="topTemp">temp: -</span>
        <button class="primary" id="sendTop" type="button">G√∂nder</button>
      </div>
    </div>

    <div id="chat" class="chat"></div>

    <div class="composer">
      <textarea id="msg" placeholder="Mesaj yaz‚Ä¶"></textarea>
    </div>
    <div class="hintRow">
      <span><span class="kbd">Enter</span> g√∂nder ‚Ä¢ <span class="kbd">Shift</span>+<span class="kbd">Enter</span> alt satƒ±r</span>
      <span id="rightHint">Hazƒ±r</span>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modalWrap" id="modalWrap">
  <div class="modal">
    <div class="modalTop">
      <b>Ayarlar</b>
      <button class="iconBtn" id="closeSettings" type="button">‚úï</button>
    </div>

    <div class="modalGrid">
      <div class="field">
        <label>≈ûablon ƒ∞√ßeriƒüi (System Prompt)</label>
        <textarea id="templateText" rows="6" placeholder="Se√ßili ≈üablonun system prompt'u..."></textarea>
        <div class="smallMuted">Bu alan se√ßili ≈üablonu ge√ßici olarak override eder (sadece bu cihazda).</div>
      </div>

      <div class="field">
        <label>Yeni ≈üablon adƒ±</label>
        <input id="newTemplateName" type="text" placeholder="√ñrn: GIS SQL Asistanƒ±" />
      </div>

      <div class="field">
        <label>Yeni ≈üablon System Prompt</label>
        <textarea id="newTemplateText" rows="5" placeholder="√ñrn: T√ºrk√ße konu≈ü. PostGIS SQL √ºret..."></textarea>
      </div>

      <div class="pillRow">
        <button id="addTemplate" class="primary" type="button">≈ûablon ekle</button>
        <button id="deleteTemplate" class="danger" type="button">Se√ßili ≈üablonu sil</button>
      </div>
    </div>

    <div class="modalActions">
      <button id="saveSettings" class="primary" type="button">Kaydet</button>
    </div>
  </div>
</div>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
/** -------------------------
 *  Storage keys
 *  ------------------------- */
const STORE_KEY = "surveyor_ai_v2";
const GOOGLE_CLIENT_ID = null; // Backend'den alƒ±nacak (/api/user/config)
const nowStr = () => new Date().toLocaleString("tr-TR", { hour12: false });

/** -------------------------
 *  Google OAuth
 *  ------------------------- */
let googleToken = null;
let currentUser = null;
let googleClientId = null;

function getAuthHeaders() {
  const headers = { "Content-Type": "application/json" };
  if (googleToken) {
    headers["Authorization"] = `Bearer ${googleToken}`;
  }
  return headers;
}

async function loadGoogleClientId() {
  try {
    const res = await fetch("/api/user/config");
    if (res.ok) {
      const data = await res.json();
      if (data.client_id) {
        return data.client_id;
      }
    }
  } catch (e) {
    console.warn("Config endpoint not available, trying fallback");
  }
  // Fallback: HTML'deki deƒüi≈üken (eƒüer set edilmi≈üse)
  return GOOGLE_CLIENT_ID || null;
}

async function initGoogleSignIn() {
  console.log("initGoogleSignIn called");
  const clientId = await loadGoogleClientId();
  console.log("Client ID loaded:", clientId ? "Yes" : "No");
  googleClientId = clientId;
  
  if (!clientId) {
    console.warn("Google Client ID not configured, authentication disabled");
    document.getElementById("loginSection").style.display = "none";
    return;
  }

  if (typeof google === 'undefined' || !google.accounts) {
    console.warn("Google Sign-In script not loaded, waiting...");
    // Script y√ºklenene kadar bekle
    const checkGoogle = setInterval(() => {
      if (typeof google !== 'undefined' && google.accounts) {
        clearInterval(checkGoogle);
        console.log("Google script loaded, initializing...");
        setupGoogleSignIn(clientId);
      }
    }, 500);
    setTimeout(() => clearInterval(checkGoogle), 10000); // 10 saniye sonra durdur
    return;
  }

  setupGoogleSignIn(clientId);
}

function setupGoogleSignIn(clientId) {
  console.log("setupGoogleSignIn called with clientId:", clientId ? "present" : "missing");
  
  google.accounts.id.initialize({
    client_id: clientId,
    callback: handleCredentialResponse,
    auto_select: false
  });

  // Butona click handler ekle - HER ZAMAN manuel handler ekle
  const signInBtn = document.getElementById("googleSignIn");
  if (!signInBtn) {
    console.error("Google Sign-In button not found!");
    return;
  }

  console.log("Adding click handler to button");
  
  // √ñnce mevcut listener'larƒ± temizle
  const newBtn = signInBtn.cloneNode(true);
  signInBtn.parentNode.replaceChild(newBtn, signInBtn);
  
  // Manuel click handler ekle
  newBtn.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log("Google Sign-In button clicked!");
    
    // Google'ƒ±n popup flow'unu kullan
    const nonce = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    const redirectUri = window.location.origin;
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${encodeURIComponent(clientId)}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=id_token&scope=openid%20profile%20email&nonce=${nonce}`;
    
    console.log("Redirecting to Google OAuth:", authUrl);
    window.location.href = authUrl;
  });

  // Google'ƒ±n renderButton'ƒ±nƒ± da dene (g√∂rsel ama√ßlƒ±, ama click handler'ƒ±mƒ±z √ßalƒ±≈üacak)
  try {
    google.accounts.id.renderButton(newBtn, { 
      theme: "outline", 
      size: "large",
      width: "100%",
      text: "signin_with",
      locale: "tr"
    });
    console.log("Google renderButton applied");
  } catch (e) {
    console.warn("Google renderButton failed (this is OK, manual handler will work):", e);
  }

  // Token kontrol√º sayfa y√ºklendiƒüinde yapƒ±lƒ±yor, burada tekrar yapmaya gerek yok
  // (√áift kontrol √∂nlemek i√ßin kaldƒ±rƒ±ldƒ±)
}

function handleCredentialResponse(response) {
  googleToken = response.credential;
  localStorage.setItem("google_token", googleToken);
  verifyToken(googleToken);
}

// OAuth redirect callback'i handle et
function handleOAuthCallback() {
  const urlParams = new URLSearchParams(window.location.hash.substring(1));
  const idToken = urlParams.get('id_token');
  if (idToken) {
    googleToken = idToken;
    localStorage.setItem("google_token", googleToken);
    verifyToken(googleToken);
    // URL'den hash'i temizle
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}

async function verifyToken(token) {
  try {
    const res = await fetch("/api/user/me", {
      headers: { "Authorization": `Bearer ${token}` }
    });
    
    if (res.ok) {
      currentUser = await res.json();
      updateUserUI(currentUser);
      loadRateLimitInfo();
    } else {
      // Token ge√ßersiz, temizle
      googleToken = null;
      localStorage.removeItem("google_token");
      showLoginUI();
    }
  } catch (e) {
    console.error("Token verification error:", e);
    showLoginUI();
  }
}

function showLoginUI() {
  document.getElementById("loginSection").style.display = "block";
  document.getElementById("userSection").style.display = "none";
  currentUser = null;
  // Rate limit bilgisini temizle
  document.getElementById("rateLimitInfo").textContent = "Giri≈ü gerekli";
}

function updateUserUI(user) {
  document.getElementById("loginSection").style.display = "none";
  document.getElementById("userSection").style.display = "block";
  
  document.getElementById("userName").textContent = user.name || user.email || "Kullanƒ±cƒ±";
  document.getElementById("userEmail").textContent = user.email || "@burakustuner.com";
  
  if (user.picture) {
    document.getElementById("userPicture").src = user.picture;
    document.getElementById("userPicture").style.display = "block";
  } else {
    document.getElementById("userPicture").style.display = "none";
  }
}

async function loadRateLimitInfo() {
  try {
    const res = await fetch("/api/user/rate-limit", {
      headers: getAuthHeaders()
    });
    if (res.ok) {
      const data = await res.json();
      updateRateLimitDisplay(data);
    } else {
      // Hata durumunda varsayƒ±lan mesaj g√∂ster
      document.getElementById("rateLimitInfo").textContent = "Y√ºklenemedi";
    }
  } catch (e) {
    console.error("Rate limit info error:", e);
    document.getElementById("rateLimitInfo").textContent = "Hata";
  }
}

function updateRateLimitDisplay(data) {
  const remaining = data.remaining || 0;
  const limit = data.limit || 100;
  const resetDate = new Date(data.reset_at * 1000);
  const resetTime = resetDate.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
  // Daha kƒ±sa format: "88/100 (01:00)"
  document.getElementById("rateLimitInfo").textContent = 
    `${remaining}/${limit} (${resetTime})`;
}

function updateRateLimitFromHeaders(response) {
  // Response header'larƒ±ndan rate limit bilgisini al
  const remaining = response.headers.get("X-RateLimit-Remaining");
  const limit = response.headers.get("X-RateLimit-Limit");
  const reset = response.headers.get("X-RateLimit-Reset");
  
  if (remaining !== null && limit !== null) {
    const remainingNum = parseInt(remaining);
    const limitNum = parseInt(limit);
    const resetDate = reset ? new Date(parseInt(reset) * 1000) : new Date(Date.now() + 3600000);
    const resetTime = resetDate.toLocaleTimeString("tr-TR", { hour: '2-digit', minute: '2-digit' });
    // Daha kƒ±sa format: "88/100 (01:00)"
    document.getElementById("rateLimitInfo").textContent = 
      `${remainingNum}/${limitNum} (${resetTime})`;
    return true; // Header'dan bilgi alƒ±ndƒ±
  }
  return false; // Header'da bilgi yok
}

document.getElementById("googleSignOut")?.addEventListener("click", () => {
  googleToken = null;
  currentUser = null;
  localStorage.removeItem("google_token");
  showLoginUI();
  // Sayfayƒ± yenile
  location.reload();
});

/** -------------------------
 *  Default templates
 *  ------------------------- */
const DEFAULT_TEMPLATES = [
  {
    id: "kisa_dogru_tr",
    name: "Kƒ±sa & doƒüru (TR)",
    system: "T√ºrk√ße konu≈ü. Sorulara DOƒûRU ve KISA cevap ver. Uydurma. Bilmiyorsan 'Bilmiyorum' de."
  },
  {
    id: "aciklayici_tr",
    name: "A√ßƒ±klayƒ±cƒ± (TR)",
    system: "T√ºrk√ße konu≈ü. Net, adƒ±m adƒ±m ve anla≈üƒ±lƒ±r a√ßƒ±kla. Bilmediƒüin yerde 'Bilmiyorum' de ve varsayƒ±m yapma."
  },
  {
    id: "kod_asistani",
    name: "Kod Asistanƒ±",
    system: "T√ºrk√ße konu≈ü. Kod √ºretirken kƒ±sa, √ßalƒ±≈üƒ±r √∂rnek ver. G√ºvenlik a√ßƒ±klarƒ±na yol a√ßacak √∂nerilerden ka√ßƒ±n. Bilmiyorsan 'Bilmiyorum' de."
  },
  {
    id: "gis_sql",
    name: "GIS SQL Asistanƒ± (PostGIS)",
    system: "T√ºrk√ße konu≈ü. Kullanƒ±cƒ± PostGIS/SQL isterse: √∂nce ihtiyacƒ± 1 c√ºmleyle √∂zetle, sonra sadece gerekli SQL'i ver. Varsayƒ±m yapma. G√ºvenli sorgu yaz (LIMIT, filtre, a√ßƒ±klama)."
  }
];

/** -------------------------
 *  State
 *  ------------------------- */
let state = loadState();
let aborter = null;

function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
    return {
      stream: s.stream ?? true,
      num_ctx: s.num_ctx ?? 4096,
      temperature: s.temperature ?? 0.7,
      historyLimit: s.historyLimit ?? 16,
      templates: s.templates ?? DEFAULT_TEMPLATES,
      templateOverride: s.templateOverride ?? {},
      sessions: s.sessions ?? [],
      activeSessionId: s.activeSessionId ?? null,
      lastModels: s.lastModels ?? [],
      selectedModel: s.selectedModel ?? "",
      selectedTemplateId: s.selectedTemplateId ?? (s.templates?.[0]?.id ?? DEFAULT_TEMPLATES[0].id),
    };
  }catch{
    return {
      stream:true, num_ctx:4096, temperature:0.7, historyLimit:16,
      templates: DEFAULT_TEMPLATES,
      templateOverride: {},
      sessions: [],
      activeSessionId: null,
      lastModels: [],
      selectedModel: "",
      selectedTemplateId: DEFAULT_TEMPLATES[0].id
    };
  }
}
function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

/** -------------------------
 *  DOM
 *  ------------------------- */
const chatEl = document.getElementById("chat");
const msgEl = document.getElementById("msg");
const modelEl = document.getElementById("model");
const modelHintEl = document.getElementById("modelHint");

const templateEl = document.getElementById("template");
const ctxEl = document.getElementById("ctx");
const tempEl = document.getElementById("temp");
const historyLimitEl = document.getElementById("historyLimit");

const ctxPill = document.getElementById("ctxPill");
const tempPill = document.getElementById("tempPill");
const streamPill = document.getElementById("streamPill");
const toggleStreamBtn = document.getElementById("toggleStream");

const newChatBtn = document.getElementById("newChat");
const clearChatBtn = document.getElementById("clearChat");
const sendBtnTop = document.getElementById("sendTop");
const rightHint = document.getElementById("rightHint");

const sessionsEl = document.getElementById("sessions");
const sessCountEl = document.getElementById("sessCount");

const chatTitleEl = document.getElementById("chatTitle");
const chatSubEl = document.getElementById("chatSub");
const topCtx = document.getElementById("topCtx");
const topTemp = document.getElementById("topTemp");
const statusDot = document.getElementById("statusDot");

/** Modal */
const modalWrap = document.getElementById("modalWrap");
const openSettingsBtn = document.getElementById("openSettings");
const closeSettingsBtn = document.getElementById("closeSettings");
const saveSettingsBtn = document.getElementById("saveSettings");
const templateTextEl = document.getElementById("templateText");
const newTemplateNameEl = document.getElementById("newTemplateName");
const newTemplateTextEl = document.getElementById("newTemplateText");
const addTemplateBtn = document.getElementById("addTemplate");
const deleteTemplateBtn = document.getElementById("deleteTemplate");

/** -------------------------
 *  Helpers
 *  ------------------------- */
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function autoGrow(){
  msgEl.style.height = "auto";
  msgEl.style.height = Math.min(msgEl.scrollHeight, 180) + "px";
}
msgEl.addEventListener("input", autoGrow);

function setStatus(ok, text){
  statusDot.style.background = ok ? "rgba(34,197,94,.85)" : "rgba(239,68,68,.85)";
  statusDot.style.boxShadow = ok ? "0 0 0 3px rgba(34,197,94,.15)" : "0 0 0 3px rgba(239,68,68,.15)";
  rightHint.textContent = text;
}

function addBubble(type, who, text, metaTag){
  const div = document.createElement("div");
  div.className = `bubble ${type}`;
  const meta = document.createElement("div");
  meta.className = "meta";
  const t = nowStr().split(" ").pop();
  meta.innerHTML =
    `<span class="who">${escapeHtml(who)}</span>` +
    (metaTag ? ` <span class="time">${escapeHtml(metaTag)}</span>` : "") +
    ` <span class="time">${escapeHtml(t)}</span>`;
  div.appendChild(meta);

  const body = document.createElement("div");
  body.textContent = text;
  div.appendChild(body);

  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  return {div, body};
}

function addThinking(metaTag){
  const div = document.createElement("div");
  div.className = "bubble bot";
  div.innerHTML = `
    <div class="meta">
      <span class="who">Ollama</span>
      ${metaTag ? `<span class="time">${escapeHtml(metaTag)}</span>` : ""}
      <span class="time" id="timerTag">d√º≈ü√ºn√ºyor‚Ä¶ 0.0s</span>
    </div>
    <div class="typingDots" aria-label="thinking">
      <span class="td"></span><span class="td"></span><span class="td"></span>
    </div>
  `;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  const timerTag = div.querySelector("#timerTag");
  return {div, timerTag};
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}

function getActiveSession(){
  if (!state.activeSessionId){
    // create one
    const s = {
      id: uid(),
      name: "Yeni sohbet",
      createdAt: Date.now(),
      updatedAt: Date.now(),
      model: state.selectedModel || "",
      templateId: state.selectedTemplateId,
      messages: []
    };
    state.sessions.unshift(s);
    state.activeSessionId = s.id;
    saveState();
  }
  return state.sessions.find(x => x.id === state.activeSessionId) || null;
}

function setActiveSession(id){
  state.activeSessionId = id;
  saveState();
  renderAll();
}

function summarizeTitleFromText(text){
  const t = text.trim().replace(/\s+/g, " ");
  if (!t) return "Yeni sohbet";
  return t.length <= 28 ? t : t.slice(0, 28) + "‚Ä¶";
}

/** -------------------------
 *  Templates
 *  ------------------------- */
function getTemplateById(id){
  return state.templates.find(t => t.id === id) || state.templates[0];
}
function getEffectiveSystemPrompt(){
  const tid = state.selectedTemplateId;
  const base = getTemplateById(tid)?.system ?? "";
  const override = state.templateOverride?.[tid];
  return (override && override.trim().length) ? override : base;
}
function renderTemplates(){
  templateEl.innerHTML = "";
  for (const t of state.templates){
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name;
    templateEl.appendChild(opt);
  }
  templateEl.value = state.selectedTemplateId;
}

/** -------------------------
 *  Sessions render
 *  ------------------------- */
function renderSessions(){
  sessCountEl.textContent = String(state.sessions.length);
  sessionsEl.innerHTML = "";

  if (state.sessions.length === 0){
    const p = document.createElement("div");
    p.className = "smallMuted";
    p.textContent = "Hen√ºz sohbet yok. ‚ÄúYeni sohbet‚Äù ile ba≈üla.";
    sessionsEl.appendChild(p);
    return;
  }

  for (const s of state.sessions){
    const el = document.createElement("div");
    el.className = "sess";
    el.onclick = () => setActiveSession(s.id);

    const left = document.createElement("div");
    left.className = "left";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = s.name || "Sohbet";
    left.appendChild(name);

    const meta = document.createElement("div");
    meta.className = "meta";
    const d = new Date(s.updatedAt || s.createdAt || Date.now());
    meta.innerHTML = `${escapeHtml(d.toLocaleString("tr-TR", {hour12:false}))} ‚Ä¢ ${escapeHtml(String(s.messages?.length || 0))} mesaj`;
    left.appendChild(meta);

    const tag = document.createElement("span");
    tag.className = "tagMini";
    tag.textContent = s.model || "-";

    el.appendChild(left);
    el.appendChild(tag);

    if (s.id === state.activeSessionId){
      el.style.outline = "2px solid rgba(59,130,246,.35)";
      el.style.background = "rgba(59,130,246,.10)";
    }

    sessionsEl.appendChild(el);
  }
}

/** -------------------------
 *  Chat render
 *  ------------------------- */
function renderChat(){
  chatEl.innerHTML = "";
  const s = getActiveSession();
  if (!s) return;

  chatTitleEl.textContent = s.name || "Sohbet";
  const upd = new Date(s.updatedAt || Date.now()).toLocaleString("tr-TR", {hour12:false});
  const streamTxt = state.stream ? "Streaming aktif" : "Streaming kapalƒ±";
  chatSubEl.textContent = `Son g√ºncelleme: ${upd} ‚Ä¢ Enter g√∂nderir ‚Ä¢ Shift+Enter alt satƒ±r ‚Ä¢ ${streamTxt}`;

  if (!s.messages || s.messages.length === 0){
    addBubble("bot", "Ollama", "Hazƒ±rƒ±m. Bir ≈üey sor üôÇ", "local");
    return;
  }

  for (const m of s.messages){
    if (m.role === "user"){
      addBubble("me", "Sen", m.content, m.model ? `model: ${m.model}` : "");
    } else if (m.role === "assistant"){
      addBubble("bot", "Ollama", m.content, m.model ? `model: ${m.model}` : "");
    } else if (m.role === "error"){
      addBubble("err", "Hata", m.content, "http");
    }
  }
}

/** -------------------------
 *  Model loading from Ollama
 *  ------------------------- */
async function loadModels(){
  try{
    modelHintEl.textContent = "Ollama'dan modeller √ßekiliyor‚Ä¶";
    const res = await fetch("/api/tags", {
      headers: getAuthHeaders()
    });
    if (!res.ok) {
      if (res.status === 401) {
        showLoginUI();
        throw new Error("Giri≈ü yapmanƒ±z gerekiyor");
      }
      throw new Error(await res.text());
    }
    const data = await res.json();
    const models = (data?.models || []).map(m => m.name).filter(Boolean);

    state.lastModels = models;
    saveState();

    modelEl.innerHTML = "";
    if (models.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Model yok (ollama pull ‚Ä¶)";
      modelEl.appendChild(opt);
      modelHintEl.textContent = "Hen√ºz model bulunamadƒ±. Sunucuda 'ollama pull ...' ile indir.";
      setStatus(false, "Model bulunamadƒ±");
      return;
    }

    for (const name of models){
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      modelEl.appendChild(opt);
    }

    // se√ßili model yoksa ilkini se√ß
    if (!state.selectedModel || !models.includes(state.selectedModel)){
      state.selectedModel = models[0];
      saveState();
    }
    modelEl.value = state.selectedModel;
    modelHintEl.textContent = `Bulunan modeller: ${models.length}`;
    setStatus(true, "Hazƒ±r");
  }catch(e){
    // fallback lastModels
    modelEl.innerHTML = "";
    const models = state.lastModels || [];
    if (models.length){
      for (const name of models){
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        modelEl.appendChild(opt);
      }
      modelEl.value = state.selectedModel || models[0];
      modelHintEl.textContent = "Ollama eri≈üimi yok gibi; son kayƒ±tlƒ± liste kullanƒ±lƒ±yor.";
    } else {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Model y√ºklenemedi";
      modelEl.appendChild(opt);
      modelHintEl.textContent = "Ollama /api/tags alƒ±namadƒ±. Nginx proxy veya Ollama √ßalƒ±≈ümƒ±yor olabilir.";
    }
    setStatus(false, "Baƒülantƒ± sorunu");
  }
}

/** -------------------------
 *  Build request messages (system + history + user)
 *  ------------------------- */
function buildMessages(prompt){
  const s = getActiveSession();
  const system = getEffectiveSystemPrompt();
  const messages = [];

  if (system && system.trim().length){
    messages.push({ role: "system", content: system.trim() });
  }

  const limit = clamp(Number(state.historyLimit) || 0, 0, 50);

  if (limit > 0 && s?.messages?.length){
    // we only include user/assistant roles; ignore errors
    const filtered = s.messages.filter(m => m.role === "user" || m.role === "assistant");
    const last = filtered.slice(-limit);
    for (const m of last){
      messages.push({ role: m.role, content: m.content });
    }
  }

  messages.push({ role: "user", content: prompt });
  return messages;
}

/** -------------------------
 *  Streaming chat call to Ollama
 *  ------------------------- */
async function ask(prompt){
  const s = getActiveSession();
  if (!s) return;

  const model = state.selectedModel;
  if (!model){
    addBubble("err", "Hata", "Model se√ßili deƒüil. /api/tags ile model √ßekilemedi.", "http");
    return;
  }

  // session metadata update
  if (!s.name || s.name === "Yeni sohbet"){
    s.name = summarizeTitleFromText(prompt);
  }
  s.model = model;
  s.templateId = state.selectedTemplateId;

  // save user message
  s.messages.push({ role:"user", content: prompt, ts: Date.now(), model });
  s.updatedAt = Date.now();
  saveState();
  renderChat();
  renderSessions();

  setStatus(true, "ƒ∞stek g√∂nderiliyor‚Ä¶");

  const started = performance.now();
  const thinking = addThinking(`model: ${model}`);
  const timer = setInterval(() => {
    const secs = (performance.now() - started) / 1000;
    thinking.timerTag.textContent = `d√º≈ü√ºn√ºyor‚Ä¶ ${secs.toFixed(1)}s`;
  }, 120);

  // We will fill assistant message progressively
  let assistantText = "";
  let assistantBubble = null;
  let firstChunkSeen = false;

  // abort previous in-flight request if any
  if (aborter) aborter.abort();
  aborter = new AbortController();

  const payload = {
    model,
    messages: buildMessages(prompt),
    stream: !!state.stream,
    options: {
      num_ctx: Number(state.num_ctx) || 4096,
      temperature: Number(state.temperature) || 0.7
    }
  };

  try{
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: getAuthHeaders(),
      body: JSON.stringify(payload),
      signal: aborter.signal
    });

    if (!res.ok){
      clearInterval(timer);
      const t = await res.text();
      thinking.div.remove();
      if (assistantBubble?.div) assistantBubble.div.remove();
      
      if (res.status === 401) {
        addBubble("err", "Hata", "Giri≈ü yapmanƒ±z gerekiyor. L√ºtfen Google ile giri≈ü yapƒ±n.", "auth");
        showLoginUI();
      } else if (res.status === 429) {
        const data = JSON.parse(t || "{}");
        addBubble("err", "Hata", `Rate limit a≈üƒ±ldƒ±. ${data.reset_at ? new Date(data.reset_at * 1000).toLocaleTimeString("tr-TR") : ""} sƒ±fƒ±rlanƒ±r.`, "rate-limit");
        loadRateLimitInfo();
      } else {
        addBubble("err", "Hata", `${res.status} ${t}`, "http");
      }
      
      s.messages.push({ role:"error", content: `${res.status} ${t}`, ts: Date.now() });
      s.updatedAt = Date.now();
      saveState();
      renderSessions();
      setStatus(false, "Hata");
      return;
    }

    // Non-stream mode
    if (!state.stream){
      thinking.div.remove();
      const data = await res.json();
      assistantText = data?.message?.content ?? "(bo≈ü cevap)";
      const created = addBubble("bot", "Ollama", assistantText, `model: ${model}`);
      assistantBubble = { div: created.div, body: created.body };

      clearInterval(timer);
      const dur = ((performance.now() - started) / 1000).toFixed(1) + "s";
      assistantBubble.div.querySelector(".meta").innerHTML =
        `<span class="who">Ollama</span> <span class="time">model: ${escapeHtml(model)}</span> <span class="time">tamamlandƒ± ‚Ä¢ ${dur}</span>`;

      s.messages.push({ role:"assistant", content: assistantText, ts: Date.now(), model });
      s.updatedAt = Date.now();
      saveState();
      renderSessions();
      setStatus(true, "Hazƒ±r");
      // Rate limit bilgisini g√ºncelle (header'dan veya API'den)
      if (!updateRateLimitFromHeaders(res)) {
        loadRateLimitInfo();
      }
      return;
    }

    // Stream mode (NDJSON lines)
    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    while (true){
      const {value, done} = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, {stream:true});

      // Ollama streams JSON objects separated by newline
      let idx;
      while ((idx = buffer.indexOf("\n")) >= 0){
        const line = buffer.slice(0, idx).trim();
        buffer = buffer.slice(idx + 1);

        if (!line) continue;

        let obj;
        try { obj = JSON.parse(line); } catch { continue; }

                const chunk = obj?.message?.content ?? "";
        if (chunk){
          if (!firstChunkSeen){
            firstChunkSeen = true;

            // ƒ∞lk token geldi: artƒ±k thinking'i kaldƒ±r, cevap balonunu olu≈ütur
            thinking.div.remove();
            const created = addBubble("bot", "Ollama", "", `model: ${model}`);
            assistantBubble = { div: created.div, body: created.body };
          }

          assistantText += chunk;
          assistantBubble.body.textContent = assistantText;
          chatEl.scrollTop = chatEl.scrollHeight;
        }


                if (obj?.done){
          const dur = ((performance.now() - started) / 1000).toFixed(1) + "s";
          if (assistantBubble?.div){
            const meta = assistantBubble.div.querySelector(".meta");
            meta.innerHTML =
              `<span class="who">Ollama</span> <span class="time">model: ${escapeHtml(model)}</span> <span class="time">tamamlandƒ± ‚Ä¢ ${dur}</span>`;
          } else {
            // hi√ß chunk gelmediyse thinking kalsƒ±n, sonra a≈üaƒüƒ±da handle edeceƒüiz
          }
        }

      }
    }

    clearInterval(timer);
    if (!firstChunkSeen){
      // streaming oldu ama hi√ß chunk gelmedi (Cloudflare buffer / baƒülantƒ± / model crash)
      thinking.div.remove();
      const created = addBubble("bot", "Ollama", "(cevap gelmedi)", `model: ${model}`);
      assistantBubble = { div: created.div, body: created.body };
      assistantText = "(cevap gelmedi)";
    }

    if (!assistantText.trim()) assistantText = "(bo≈ü cevap)";
    s.messages.push({ role:"assistant", content: assistantText, ts: Date.now(), model });
    s.updatedAt = Date.now();
    saveState();
    renderSessions();
    setStatus(true, "Hazƒ±r");
    // Rate limit bilgisini g√ºncelle (header'dan veya API'den)
    // Not: Streaming response'da header'larƒ± almak i√ßin response'u saklamamƒ±z gerekir
    loadRateLimitInfo();

  }catch(e){
    clearInterval(timer);
    thinking.div.remove();
    if (assistantBubble?.div) assistantBubble.div.remove();
    addBubble("err", "Hata", String(e), "client");
    const s2 = getActiveSession();
    s2.messages.push({ role:"error", content: String(e), ts: Date.now() });
    s2.updatedAt = Date.now();
    saveState();
    renderSessions();
    setStatus(false, "Hata");
  }
}

/** -------------------------
 *  UI bindings
 *  ------------------------- */
function renderControls(){
  renderTemplates();

  ctxEl.value = String(clamp(Number(state.num_ctx) || 4096, 256, 32768));
  tempEl.value = String(clamp(Number(state.temperature) || 0.7, 0, 1.5));
  historyLimitEl.value = String(clamp(Number(state.historyLimit) || 16, 0, 50));

  ctxPill.textContent = `ctx: ${ctxEl.value}`;
  tempPill.textContent = `temp: ${Number(tempEl.value).toFixed(2)}`;
  topCtx.textContent = `ctx: ${ctxEl.value}`;
  topTemp.textContent = `temp: ${Number(tempEl.value).toFixed(2)}`;

  if (state.stream){
    toggleStreamBtn.textContent = "Aktif";
    toggleStreamBtn.classList.add("primary");
    streamPill.textContent = "stream: on";
  } else {
    toggleStreamBtn.textContent = "Kapalƒ±";
    toggleStreamBtn.classList.remove("primary");
    streamPill.textContent = "stream: off";
  }
}

function renderAll(){
  renderControls();
  renderSessions();
  renderChat();
}

modelEl.addEventListener("change", () => {
  state.selectedModel = modelEl.value;
  const s = getActiveSession();
  if (s){
    s.model = state.selectedModel;
    s.updatedAt = Date.now();
  }
  saveState();
  renderSessions();
});

templateEl.addEventListener("change", () => {
  state.selectedTemplateId = templateEl.value;
  const s = getActiveSession();
  if (s){
    s.templateId = state.selectedTemplateId;
    s.updatedAt = Date.now();
  }
  saveState();
});

ctxEl.addEventListener("input", () => {
  state.num_ctx = clamp(Number(ctxEl.value) || 4096, 256, 32768);
  saveState();
  ctxPill.textContent = `ctx: ${state.num_ctx}`;
  topCtx.textContent = `ctx: ${state.num_ctx}`;
});

tempEl.addEventListener("input", () => {
  state.temperature = clamp(Number(tempEl.value) || 0.7, 0, 1.5);
  saveState();
  const t = state.temperature.toFixed(2);
  tempPill.textContent = `temp: ${t}`;
  topTemp.textContent = `temp: ${t}`;
});

historyLimitEl.addEventListener("input", () => {
  state.historyLimit = clamp(Number(historyLimitEl.value) || 0, 0, 50);
  saveState();
});

toggleStreamBtn.addEventListener("click", () => {
  state.stream = !state.stream;
  saveState();
  renderControls();
  renderChat();
});

newChatBtn.addEventListener("click", () => {
  const s = {
    id: uid(),
    name: "Yeni sohbet",
    createdAt: Date.now(),
    updatedAt: Date.now(),
    model: state.selectedModel || "",
    templateId: state.selectedTemplateId,
    messages: []
  };
  state.sessions.unshift(s);
  state.activeSessionId = s.id;
  saveState();
  renderAll();
  msgEl.focus();
});

clearChatBtn.addEventListener("click", () => {
  const s = getActiveSession();
  if (!s) return;
  s.messages = [];
  s.updatedAt = Date.now();
  s.name = "Yeni sohbet";
  saveState();
  renderAll();
  msgEl.focus();
});

sendBtnTop.addEventListener("click", () => {
  const text = msgEl.value.trim();
  if (!text) return;
  msgEl.value = "";
  autoGrow();
  ask(text);
});

msgEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendBtnTop.click();
  }
});

/** -------------------------
 *  Settings modal
 *  ------------------------- */
function openModal(){
  modalWrap.style.display = "grid";
  const tid = state.selectedTemplateId;
  templateTextEl.value = state.templateOverride?.[tid] ?? getTemplateById(tid)?.system ?? "";
}
function closeModal(){
  modalWrap.style.display = "none";
}
openSettingsBtn.onclick = openModal;
closeSettingsBtn.onclick = closeModal;
modalWrap.addEventListener("click", (e) => {
  if (e.target === modalWrap) closeModal();
});

saveSettingsBtn.onclick = () => {
  const tid = state.selectedTemplateId;
  state.templateOverride = state.templateOverride || {};
  state.templateOverride[tid] = templateTextEl.value;
  saveState();
  closeModal();
};

addTemplateBtn.onclick = () => {
  const name = (newTemplateNameEl.value || "").trim();
  const txt = (newTemplateTextEl.value || "").trim();
  if (!name || !txt){
    alert("≈ûablon adƒ± ve i√ßeriƒüi bo≈ü olamaz.");
    return;
  }
  const t = { id: uid(), name, system: txt };
  state.templates.push(t);
  state.selectedTemplateId = t.id;
  newTemplateNameEl.value = "";
  newTemplateTextEl.value = "";
  saveState();
  renderAll();
  openModal();
};

deleteTemplateBtn.onclick = () => {
  const tid = state.selectedTemplateId;
  const t = getTemplateById(tid);
  if (!t) return;
  const ok = confirm(`"${t.name}" ≈üablonu silinsin mi?`);
  if (!ok) return;

  state.templates = state.templates.filter(x => x.id !== tid);
  delete (state.templateOverride || {})[tid];
  if (state.templates.length === 0){
    state.templates = DEFAULT_TEMPLATES;
  }
  state.selectedTemplateId = state.templates[0].id;
  saveState();
  renderAll();
  openModal();
};

/** -------------------------
 *  Init
 *  ------------------------- */
(function init(){
  // Ensure at least one session
  if (!state.sessions || state.sessions.length === 0){
    const s = {
      id: uid(),
      name: "Yeni sohbet",
      createdAt: Date.now(),
      updatedAt: Date.now(),
      model: state.selectedModel || "",
      templateId: state.selectedTemplateId,
      messages: []
    };
    state.sessions = [s];
    state.activeSessionId = s.id;
    saveState();
  } else if (!state.activeSessionId){
    state.activeSessionId = state.sessions[0].id;
    saveState();
  }

  renderAll();
  autoGrow();
  msgEl.focus();
  
  // OAuth callback'i kontrol et
  if (window.location.hash.includes('id_token=')) {
    handleOAuthCallback();
  } else {
    // Sayfa y√ºklendiƒüinde token kontrol√º yap (Google script'i beklemeden)
    const storedToken = localStorage.getItem("google_token");
    if (storedToken) {
      console.log("Found stored token on page load, verifying...");
      googleToken = storedToken;
      verifyToken(storedToken);
    } else {
      // Token yoksa login UI'ƒ± g√∂ster
      showLoginUI();
    }
  }
  
  // Google Sign-In'i ba≈ülat
  console.log("Initializing Google Sign-In...");
  console.log("Google object:", typeof google !== 'undefined' ? "loaded" : "not loaded");
  
  // Script y√ºklenmesini bekle
  function waitForGoogle() {
    if (typeof google !== 'undefined' && google.accounts) {
      console.log("Google script is ready");
      initGoogleSignIn();
    } else {
      console.log("Waiting for Google script...");
      setTimeout(waitForGoogle, 500);
    }
  }
  
  // Sayfa y√ºklendikten sonra ba≈ülat
  if (document.readyState === 'loading') {
    window.addEventListener('load', () => {
      setTimeout(waitForGoogle, 1000);
    });
  } else {
    setTimeout(waitForGoogle, 1000);
  }
  
  loadModels();
})();
</script>

</body>
</html>
